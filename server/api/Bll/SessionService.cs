using Api.Domain.Enums.Channel;
using Api.Domain.HubModels;
using Api.Domain.Interfaces.Bll;
using Api.Domain.Interfaces.Dal;
using Api.Domain.ViewModels.Server;
using AutoMapper;
using Microsoft.EntityFrameworkCore;

namespace Api.Bll
{
    public class SessionService : ISessionService
    {
        private readonly ISessionRepository _sessionRepository;
        private readonly IMessageRepository _messageRepository;
        private readonly IReviewService _reviewService;
        private readonly IMapper _mapper;
        public SessionService(ISessionRepository sessionRepository, IMessageRepository messageRepository, IMapper mapper, IReviewService reviewService)
        {
            _sessionRepository = sessionRepository;
            _messageRepository = messageRepository;
            _mapper = mapper;
            _reviewService = reviewService;
        }

        public async Task<SessionResponse> CreateSession(SessionRequest session, string name, Guid id)
        {
            var newsession = await _sessionRepository.Create(session, name, id);
            var msg = new MessageVModel()
            {
                SessionId = newsession.Id,
                UserName = "ADMIN",
                Date = DateTime.Now,
                Text = $"Sesión {session.Name} creada por {name}",
                IsModerated = false,
                IsProfessional = false,
                IsAutogenerated = true
            };
            await _messageRepository.Create(msg);
            newsession.Messages.Add(msg);
            return newsession;
        }

        public async Task<bool> CloseSession(int id)
        {
            return await _sessionRepository.Close(id);
        }

        public async Task<IEnumerable<SessionResponse>> GetAllSessions()
        {
            try
            {
                var query = await _sessionRepository.GetAll();
                var sessions = await query
                    .Where(s => s.State != CHANNEL_STATE.FINISHED)
                    .ToListAsync();
                return _mapper.Map<IEnumerable<SessionResponse>>(sessions);
            }
            catch (Exception ex)
            {
                throw;
            }
        }

        public async Task<SessionResponse> GetSessionById(int id)
        {
            var response = await _sessionRepository.GetById(id);
            var review = await _reviewService.GetAllByUser(response.ModeratorId);
            if (review != null) response.Reviews = review;
            return response;
        }

        public Task<SessionResponse> UpdateSession(int id, SessionRequest updateSession)
        {
            throw new NotImplementedException();
        }
    }
}
